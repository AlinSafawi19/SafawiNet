# Use Node.js 20 Alpine as base image
FROM node:20-alpine

# Install additional packages for better network handling
RUN apk add --no-cache curl

# Set working directory
WORKDIR /app

# Copy package files and npm configuration
COPY package*.json .npmrc ./

# Install dependencies with multiple fallback strategies
RUN npm cache clean --force && \
    (npm ci --prefer-offline --no-audit --no-fund || \
     (echo "npm ci failed, trying with different registry..." && \
      npm config set registry https://registry.npmjs.org/ && \
      npm ci --prefer-offline --no-audit --no-fund) || \
     (echo "npm ci failed, trying npm install..." && \
      npm install --prefer-offline --no-audit --no-fund) || \
     (echo "All methods failed, trying with legacy peer deps..." && \
      npm install --legacy-peer-deps --no-audit --no-fund))

# Copy source code
COPY . .

# Expose port
EXPOSE 3001

# Start the development server with hot reloading
CMD ["npm", "run", "dev"]
